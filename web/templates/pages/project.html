{% extends 'base.html' %}

{% block title %}{{project}}{% endblock title %}

{% block content %}

  <div class="container">
    <div class="row">
      <div class="col-3">
        
        <div class="card">
          <div class="card-body">

            <h3 class="card-title text-center">{{project}}</h3>

            <nav class="mt-4">
              <div class="nav nav-tabs nav-justified" id="nav-tab" role="tablist">
                <button class="nav-link active" id="nav-information-tab" data-bs-toggle="tab" data-bs-target="#nav-information" type="button" role="tab" aria-controls="nav-information" aria-selected="true">Information</button>
                <button class="nav-link" id="nav-members-tab" data-bs-toggle="tab" data-bs-target="#nav-members" type="button" role="tab" aria-controls="nav-members" aria-selected="false">Members</button>
              </div>
            </nav>

            <div class="tab-content mt-3" id="nav-tabContent">
              <div class="tab-pane fade show active" id="nav-information" role="tabpanel" aria-labelledby="nav-information-tab">
                
                <div class="mb-3">
                  <label for="project-name" class="form-label">Project Name</label>
                  <input
                    readonly
                    value="{{project.name}}"
                    type="text"
                    class="form-control"
                    id="project-name"
                  >
                </div>
                
                <div class="mb-3">
                  <label for="project-id" class="form-label">Project Identifier</label>
                  <input
                    readonly
                    value="{{project.id}}"
                    type="text"
                    class="form-control"
                    id="project-id"
                  >
                </div>

                <div class="float-end">
                  <form
                    method="POST"
                    action="/delete/project/{{project.id}}/"
                  >
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="btn btn-sm btn-danger"
                    >
                      <i class="fa fa-trash"></i>
                    </button>
                  </form>
                </div>

              </div>
              
              <div class="tab-pane fade" id="nav-members" role="tabpanel" aria-labelledby="nav-profile-tab">
                
                <ul class="list-group">

                  {% for user in project.users.all %}
                    <li class="list-group-item">{{user.username}}</li>
                  {% endfor %}

                </ul>

              </div>

            </div>
          </div>
        </div>

      </div>
      <div class="col">

        <div id="log-list" class="list-group"></div>
      
        <div class="text-muted mt-3">
          {% if page.current != 1 %}
            <a href="/project/{{project.id}}/{{page.current|add:'-1'}}">« previous<a>
          {% endif %}

          page {{page.current}} of {{page.num_pages}}

          {% if page.current < page.num_pages %}
            <a href="/project/{{project.id}}/{{page.current|add:'1'}}">next »</a>
          {% endif %}
        </div>

      </div>
    </div>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2">
    <div id="new-log-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">New Log</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        A new log has been pushed.
      </div>
    </div>
  </div>
  
  <script type="text/javascript">
    const logs = JSON.parse('{{logs|safe}}').reverse();
    
    logs.forEach(({ fields: { event, created }, pk}) => {
      renderLog(event, created, pk);
    });

    function renderLog(event, created, id) {
      const logList = document.getElementById('log-list');
      const options = {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
      };
      const date = new Date(created).toLocaleDateString('en-US', options);
      const newLog = `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              ${event}
              <div class="d-flex">
                <span class="text-end text-muted me-3">${date}</span>

                <form
                  method="POST"
                  action="/delete/log/${id}/"
                >

                  {% csrf_token %}

                  <button
                    type="submit"
                    class="btn btn-sm btn-danger"
                  >
                    <i class="fa fa-trash"></i>
                  </button>
                </form>
                
              </div>
            </li>
      `;
      logList.innerHTML = newLog + logList.innerHTML;
    }
  </script>

  <script type="text/javascript">
    const projectID = {{project.id}};
    const logList = document.getElementById('log-list');
    const currentPage = {{page.current}};
    const newLogToast = document.getElementById('new-log-toast');

    const logSocket = new WebSocket(
      'ws://localhost:8000'
      + '/ws/project/'
      + projectID
      + '/'
    );

    logSocket.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (currentPage == 1)
        renderLog(data.log.event, data.log.created, data.log.id);
      else {
        const toast = new bootstrap.Toast(newLogToast);
        toast.show();
      }
        
    };

    logSocket.onclose = function(event) {
      console.error('Chat socket closed unexpectedly');
    };

  </script>

{% endblock content %}